name: AWS EC2 Self-Hosted Runner

on:
  workflow_dispatch: # Manual trigger only

env:
  AWS_REGION: us-east-1
  INSTANCE_TYPE: t2.micro
  AMI_ID: ami-08982f1c5bf93d976
  RUNNER_LABEL: ephemeral-runner
  RUNNER_NAME: aws-runner

permissions:
  actions: write
  contents: read

jobs:
  launch-runner:
    name: Launch EC2 and Configure Runner
    runs-on: ubuntu-latest
    outputs:
      instance_id: ${{ steps.launch-ec2.outputs.instance_id }}
      public_ip: ${{ steps.launch-ec2.outputs.public_ip }}
      runner_token: ${{ steps.get-token.outputs.runner_token }}

    steps:
      # 1. Configure AWS CLI
      - name: Configure AWS CLI
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set aws_session_token ${{ secrets.AWS_SESSION_TOKEN }}
          aws configure set default.region $AWS_REGION

      # 2. Ensure Default VPC Exists
      - name: Ensure Default VPC
        id: ensure-vpc
        run: |
          echo "Checking for default VPC..."
          default_vpc=$(aws ec2 describe-vpcs --filters Name=isDefault,Values=true --query 'Vpcs[0].VpcId' --output text)

          if [ "$default_vpc" == "None" ] || [ -z "$default_vpc" ]; then
            echo "No default VPC found. Creating one..."
            default_vpc=$(aws ec2 create-default-vpc --query 'Vpc.VpcId' --output text)
            echo "Created default VPC: $default_vpc"
          else
            echo "Default VPC exists: $default_vpc"
          fi

          echo "vpc_id=$default_vpc" >> $GITHUB_OUTPUT

      # 3. Ensure Default Security Group Exists and Open SSH
      - name: Ensure Security Group
        id: ensure-sg
        run: |
          vpc_id=${{ steps.ensure-vpc.outputs.vpc_id }}

          echo "Checking for default security group in VPC $vpc_id..."
          default_sg=$(aws ec2 describe-security-groups \
            --filters Name=vpc-id,Values=$vpc_id Name=group-name,Values=default \
            --query 'SecurityGroups[0].GroupId' --output text)

          if [ "$default_sg" == "None" ] || [ -z "$default_sg" ]; then
            echo "Default security group missing, creating one..."
            default_sg=$(aws ec2 create-security-group \
              --group-name default \
              --description "Default SG for GH Runner" \
              --vpc-id $vpc_id \
              --query 'GroupId' --output text)
          else
            echo "Default security group exists: $default_sg"
          fi

          echo "Authorizing SSH inbound rule (22)..."
          aws ec2 authorize-security-group-ingress \
            --group-id $default_sg \
            --protocol tcp --port 22 --cidr 0.0.0.0/0 || echo "Rule already exists"

          echo "sg_id=$default_sg" >> $GITHUB_OUTPUT

      - name: Generate GitHub Runner Token with Curl
        id: get-token
        run: |
          token=$(curl -sL \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token \
            | jq -r .token)
          if [ -z "$token" ] || [ "$token" == "null" ]; then
            echo "Failed to obtain runner token"
            exit 1
          fi
          echo "Obtained runner token"
          echo "runner_token=$token" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare User Data Script
        run: |
          cp install-runner.sh user_data_custom.sh
          sed -i "s|{{GITHUB_REPO_URL}}|https://github.com/${{ github.repository }}|g" user_data_custom.sh
          sed -i "s|{{GITHUB_TOKEN}}|${{ steps.get-token.outputs.runner_token }}|g" user_data_custom.sh
          sed -i "s|{{RUNNER_NAME}}|runner-$(date +%s)|g" user_data_custom.sh
          echo "User Data script prepared with actual values"

      # 5. Launch EC2 Instance
      - name: Launch EC2 Instance
        id: launch-ec2
        run: |
          vpc_id=${{ steps.ensure-vpc.outputs.vpc_id }}
          sg_id=${{ steps.ensure-sg.outputs.sg_id }}

          echo "Finding a subnet in default VPC $vpc_id..."
          subnet_id=$(aws ec2 describe-subnets --filters Name=vpc-id,Values=$vpc_id --query 'Subnets[0].SubnetId' --output text)

          if [ "$subnet_id" == "None" ] || [ -z "$subnet_id" ]; then
            echo "No subnet found in default VPC. Cannot continue."
            exit 1
          fi

          echo "Launching EC2 instance in subnet $subnet_id..."
          instance_id=$(aws ec2 run-instances \
            --image-id $AMI_ID \
            --instance-type $INSTANCE_TYPE \
            --iam-instance-profile Name=EC2RunnerRole \
            --subnet-id $subnet_id \
            --security-group-ids $sg_id \
            --associate-public-ip-address \
            --user-data file://user_data_custom.sh \
            --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=GH-Runner}]' \
            --query 'Instances[0].InstanceId' --output text)

          echo "Waiting for instance to be running..."
          aws ec2 wait instance-running --instance-ids $instance_id

          public_ip=$(aws ec2 describe-instances \
            --instance-ids $instance_id \
            --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)

          echo "instance_id=$instance_id" >> $GITHUB_OUTPUT
          echo "public_ip=$public_ip" >> $GITHUB_OUTPUT

          echo "Launched instance $instance_id with public IP $public_ip"
